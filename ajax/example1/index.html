<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html dir="ltr" xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta content="text/html; charset=windows-1252" http-equiv="Content-Type" />
        <title>Ajax Streaming without polling / xhr</title>
        <style type='text/css'>
            #divProgress{
                border:2px solid #ddd; 
                padding:10px; 
                width:300px; 
                height:265px; 
                margin-top: 10px;
                overflow:auto; 
                background:#f5f5f5;
            }

            #progress_wrapper{
                border:2px solid #ddd;
                width:321px; 
                height:20px; 
                overflow:auto; 
                background:#f5f5f5;
                margin-top: 10px;
            }

            #progressor{
                background:#07c; 
                width:0%; 
                height:100%;
                -webkit-transition: all 1s linear;
                -moz-transition: all 1s linear;
                -o-transition: all 1s linear;
                transition: all 1s linear; 

            }

            .demo_container{
                width: 680px;
                margin:0 auto;
                padding: 30px;
                background: #FFF;
                margin-top: 50px;
            }

            .my-btn, .my-btn2{
                width: 297px;
                margin-top: 22px;
                float: none;
                display: block;
            }

            h1{
                font-size: 22px;
                margin-bottom: 20px;
            }

            .float_left{
                float: left;
            }

            .float_right{
                float: right;
            }

            .demo_container::after {
                content: "";
                clear: both;
                display: block;
            }

            .ghost-btn.active {
                border: 2px solid #D23725;
                color: #D23725;
            }

            .ghost-btn {
                display: inline-block;
                text-decoration: none;
                border: 2px solid #3b8dbd;
                line-height: 15px;
                color: #3b8dbd;
                -webkit-border-radius: 3px;
                -webkit-background-clip: padding-box;
                -moz-border-radius: 3px;
                -moz-background-clip: padding;
                border-radius: 3px;
                background-clip: padding-box;
                font-size: 15px;
                padding: .6em 1.5em;
                -webkit-transition: all 0.2s ease-out;
                -moz-transition: all 0.2s ease-out;
                -o-transition: all 0.2s ease-out;
                transition: all 0.2s ease-out;
                background: #ffffff;
                -webkit-box-sizing: content-box;
                -moz-box-sizing: content-box;
                box-sizing: content-box;
                cursor: pointer;
                zoom: 1;
                -webkit-backface-visibility: hidden;
                position: relative;
                margin-right: 10px;
            }
            .ghost-btn:hover {
                -webkit-transition: 0.2s ease;
                -moz-transition: 0.2s ease;
                -o-transition: 0.2s ease;
                transition: 0.2s ease;
                background-color: #3b8dbd;
                color: #ffffff;
            }
            .ghost-btn:focus {
                outline: none;
            }

            .ghost-btn.active {
                border: 2px solid #D23725;
                color: #D23725;
            }

            .ghost-btn.active:hover {
                border: 2px solid #D23725;
                background: #FFF;
            }

            .method_wrappers{
                margin-bottom: 20px;
            }
        </style>
    </head>

    <body>
        <div class="demo_container">
            <h1>AJAX progress bar for PHP script without polling (XHR method)</h1>
            <div class='float_left'>
                <h3>Progress Bar</h3>
                <div id='progress_wrapper'>
                    <div id="progressor"></div>
                </div>
                <a onclick="ajax_stream();" class='my-btn'>Start Ajax Streaming</a>
                <form method="get" action="ajax_stream.php">
                    <button type="submit">TESDT</button>
                </form>
            </div>
            <div class='float_right'>
                <h3>Log</h3>
                <div id="divProgress"></div>
            </div>
        </div>
        <script>
            function ajax_stream() {
                console.log("Start AjaxStream");
                if (!window.XMLHttpRequest) {
                    console.log("Your browser does not support the native XMLHttpRequest object.");
                    return;
                }
                try {
                    var xhr = new XMLHttpRequest();
                    xhr.previous_text = '';

                    xhr.onerror = function () {
                        console.log("[XHR] Fatal Error.");
                    };
                    xhr.onreadystatechange = function () {
                        try {
                            if (xhr.readyState == 4) {
                                console.log('[XHR] Done')
                            }
                            else if (xhr.readyState > 2) {
                                var new_response = xhr.responseText.substring(xhr.previous_text.length);
                                var result = JSON.parse(new_response);

                                document.getElementById("divProgress").innerHTML += result.message + '<br />';
                                document.getElementById('progressor').style.width = result.progress + "%";

                                xhr.previous_text = xhr.responseText;
                            }
                        }
                        catch (e) {
                            console.log("[XHR STATECHANGE] Exception: " + e);
                        }
                    };
                    xhr.open("GET", "ajax", true);
                    xhr.send();
                }
                catch (e) {
                    console.log("[XHR REQUEST] Exception: " + e);
                }
            }
        </script>
    </body>
</html>